# Immediate Actions Required - Deployment Security

**Date**: 2026-01-22
**Priority**: CRITICAL
**Time Required**: 30 minutes to 2 hours

This document outlines **immediate low-effort, high-impact fixes** that should be implemented today, before the larger infrastructure changes.

---

## Quick Wins (30 minutes total)

### 1. Update .env.example (5 minutes)

**Current file is missing critical documentation and secrets.**

Replace `/home/claudev/code/eladmallel/rsvp-reader-galore/rsvp-reader/.env.example` with:

```bash
# =============================================================================
# RSVP Reader Environment Configuration
# =============================================================================
# Copy this file to .env.local and fill in your values
# NEVER commit .env.local to git - it contains secrets!

# -----------------------------------------------------------------------------
# Supabase Configuration (Production)
# -----------------------------------------------------------------------------
# Get these from: https://supabase.com/dashboard/project/_/settings/api
NEXT_PUBLIC_SUPABASE_URL=your-project-url
NEXT_PUBLIC_SUPABASE_ANON_KEY=your-anon-key
SUPABASE_SERVICE_ROLE_KEY=your-service-role-key

# -----------------------------------------------------------------------------
# Test Environment (IMPORTANT: Use separate Supabase project for testing!)
# -----------------------------------------------------------------------------
# Option 1: Supabase Local Development (recommended)
#   Install: npx supabase init && npx supabase start
#   These values are auto-generated by Supabase CLI
TEST_SUPABASE_URL=http://localhost:54321
TEST_SUPABASE_ANON_KEY=your-local-anon-key
TEST_SUPABASE_SERVICE_ROLE_KEY=your-local-service-key

# Option 2: Separate Supabase Test Project (not recommended - costs money)
#TEST_SUPABASE_URL=https://your-test-project.supabase.co
#TEST_SUPABASE_ANON_KEY=your-test-anon-key
#TEST_SUPABASE_SERVICE_ROLE_KEY=your-test-service-key

# -----------------------------------------------------------------------------
# Readwise Reader API
# -----------------------------------------------------------------------------
# Get token from: https://readwise.io/access_token
# WARNING: Use a TEST account token for integration tests!
# Do NOT use your production Readwise account for testing.
READWISE_ACCESS_TOKEN=your-readwise-token

# -----------------------------------------------------------------------------
# Sync API Protection
# -----------------------------------------------------------------------------
# Used to protect the /api/sync/readwise endpoint from unauthorized access
# Generate a secure random key:
#   openssl rand -hex 32
# Or:
#   node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
SYNC_API_KEY=generate-random-secret-key-here

# -----------------------------------------------------------------------------
# Optional: Rate Limiting Configuration
# -----------------------------------------------------------------------------
# These settings control API rate limiting to prevent abuse
RATE_LIMIT_WINDOW_MS=60000        # 1 minute window
RATE_LIMIT_MAX_REQUESTS=100       # Max requests per window

# -----------------------------------------------------------------------------
# Optional: Encryption Key (for sensitive data at rest)
# -----------------------------------------------------------------------------
# Used to encrypt sensitive tokens in the database
# Generate: openssl rand -base64 32
#ENCRYPTION_KEY=your-32-byte-encryption-key-here
```

**Action**: Copy this content to `.env.example` immediately.

---

### 2. Document Test Database Separation (10 minutes)

Add warning to README.md after the "Environment Variables" section:

````markdown
### ⚠️ CRITICAL: Test Environment Isolation

**IMPORTANT**: Never use your production Supabase database for testing!

Tests create, modify, and delete data. Using production credentials will corrupt your live data.

**Setup for safe testing**:

1. **Option A: Supabase Local (Recommended)**

   ```bash
   # Install Supabase CLI
   npm install -g supabase

   # Start local Supabase stack
   npx supabase init
   npx supabase start

   # Copy test credentials to .env.local
   npx supabase status -o env >> .env.local
   ```
````

2. **Option B: Separate Test Project**
   - Create a new Supabase project specifically for testing
   - Use different credentials in your `.env.local`
   - Never point tests at production

**Verify isolation**: Before running tests, check your `.env.local`:

```bash
echo "Production DB: $NEXT_PUBLIC_SUPABASE_URL"
echo "Test DB: $TEST_SUPABASE_URL"
# These should be DIFFERENT!
```

````

**Action**: Add this section to README.md under "Environment Variables".

---

### 3. Add .env.local to .gitignore (Already done, verify)

**Check**: Verify `.env.local` is in `.gitignore`:

```bash
grep -q "^\.env\*$" .gitignore && echo "✓ Safe" || echo "✗ DANGER"
````

Current `.gitignore` line 39: `✓ .env*` (with exception for `.env.example`)

**Status**: ✅ Already protected

---

### 4. Add Security Headers to Next.js Config (10 minutes)

Update `/home/claudev/code/eladmallel/rsvp-reader-galore/rsvp-reader/next.config.ts`:

```typescript
import type { NextConfig } from 'next';

const nextConfig: NextConfig = {
  reactCompiler: true,

  // Security headers
  async headers() {
    return [
      {
        // Apply security headers to all routes
        source: '/:path*',
        headers: [
          {
            key: 'X-Frame-Options',
            value: 'DENY',
          },
          {
            key: 'X-Content-Type-Options',
            value: 'nosniff',
          },
          {
            key: 'Referrer-Policy',
            value: 'origin-when-cross-origin',
          },
          {
            key: 'X-XSS-Protection',
            value: '1; mode=block',
          },
          {
            key: 'Permissions-Policy',
            value: 'camera=(), microphone=(), geolocation=()',
          },
        ],
      },
    ];
  },
};

export default nextConfig;
```

**Benefits**:

- Prevents clickjacking attacks
- Prevents MIME type sniffing
- Limits browser features access
- Improves security score

**Action**: Update `next.config.ts` with these headers.

---

### 5. Document Secret Rotation (5 minutes)

Create `/home/claudev/code/eladmallel/rsvp-reader-galore/rsvp-reader/docs/devops/secret-rotation.md`:

````markdown
# Secret Rotation Procedures

## When to Rotate Secrets

- **Immediately**: If a secret is compromised or exposed
- **Quarterly**: Routine rotation for compliance
- **After**: Team member leaves with access

## How to Rotate Each Secret

### Supabase Keys

1. Go to Supabase Dashboard > Project Settings > API
2. Click "Reset" next to the key you want to rotate
3. Update environment variables:
   - Local: `.env.local`
   - CI: GitHub Secrets
   - Production: Vercel Environment Variables
4. Redeploy application
5. Verify application still works

### SYNC_API_KEY

1. Generate new key:
   ```bash
   openssl rand -hex 32
   ```
````

2. Update in all environments
3. Update cron script/caller with new key
4. Old key is immediately invalid (no grace period)

### Readwise Access Token

1. Go to https://readwise.io/access_token
2. Revoke old token
3. Generate new token
4. Update `.env.local`
5. Update CI secrets if used in integration tests

## Emergency Revocation

If a secret is exposed publicly (e.g., committed to git):

1. **Immediately** rotate the secret (follow above procedures)
2. Check git history: `git log -p -- .env.local`
3. If secret was committed:
   - Rotate secret immediately
   - Consider rewriting git history (destructive)
   - Notify team
   - Monitor for unauthorized access

## Verification Checklist

After rotating secrets:

- [ ] Local development works
- [ ] Tests pass
- [ ] CI/CD pipeline succeeds
- [ ] Production deployment healthy
- [ ] No authentication errors in logs
- [ ] Background jobs (sync) still running

````

**Action**: Create this file as reference documentation.

---

## Medium Priority (1-2 hours)

### 6. Add npm audit to CI (15 minutes)

Update `.github/workflows/main.yml` to add security scanning:

```yaml
jobs:
  test:
    runs-on: ubuntu-latest
    # ... existing config ...
    steps:
      # ... existing steps ...

      - name: Security audit
        run: npm audit --audit-level=high
        continue-on-error: true  # Don't block builds on low-severity issues
````

**Position**: After "Install dependencies" step, before tests.

---

### 7. Add Rate Limit Warning Comments (30 minutes)

Add clear warnings in files that use external APIs:

**File**: `/home/claudev/code/eladmallel/rsvp-reader-galore/rsvp-reader/package.json`

Update line 20:

```json
"test:integration": "echo 'WARNING: This hits real Readwise API (20 req/min limit)' && source .env.local && READWISE_ACCESS_TOKEN=$READWISE_ACCESS_TOKEN vitest run api.integration",
```

**File**: `/home/claudev/code/eladmallel/rsvp-reader-galore/rsvp-reader/src/lib/reader/api.integration.test.ts`

Add at top of file:

```typescript
/**
 * ⚠️ WARNING: Integration tests using real Readwise API
 *
 * These tests hit the REAL Readwise API with rate limits (20 req/min).
 * They require a valid READWISE_ACCESS_TOKEN environment variable.
 *
 * IMPORTANT:
 * - Use a TEST Readwise account, NOT your production account
 * - Wait 60 seconds between test runs if you hit rate limits
 * - Consider implementing a Readwise API stub for faster, more reliable tests
 *
 * TODO: Replace with stub server to avoid rate limits and external dependency
 *
 * Run with:
 *   npm run test:integration
 */
```

---

### 8. Create Security Checklist (15 minutes)

Create `/home/claudev/code/eladmallel/rsvp-reader-galore/rsvp-reader/docs/devops/SECURITY-CHECKLIST.md`:

```markdown
# Security Checklist

## Before Each Deployment

- [ ] All tests pass (unit, integration, E2E)
- [ ] No secrets in code or git history
- [ ] Environment variables documented in .env.example
- [ ] No console.log with sensitive data
- [ ] Rate limits configured on new API routes
- [ ] Input validation on all user inputs
- [ ] Authentication required on protected routes
- [ ] RLS policies applied to new database tables

## Weekly Review

- [ ] Check GitHub security alerts
- [ ] Review npm audit results
- [ ] Check error logs for anomalies
- [ ] Verify test database isolation
- [ ] Review API usage metrics

## Monthly Review

- [ ] Rotate API keys and tokens
- [ ] Review user access permissions
- [ ] Check database size and optimize
- [ ] Review and update dependencies
- [ ] Test disaster recovery procedures

## Quarterly Review

- [ ] Full security audit
- [ ] Penetration testing
- [ ] Review and update security policies
- [ ] Review third-party integrations
- [ ] Update security documentation
```

---

## Verification Steps

After implementing quick wins:

1. **Verify .env.example is complete**:

   ```bash
   grep -E "SUPABASE|READWISE|SYNC_API_KEY" .env.example
   # Should show all required variables
   ```

2. **Verify security headers work**:

   ```bash
   npm run dev
   curl -I http://localhost:3000 | grep -E "X-Frame-Options|X-Content-Type-Options"
   # Should show security headers
   ```

3. **Verify tests still pass**:

   ```bash
   npm run test
   # All tests should pass
   ```

4. **Verify no secrets in git**:
   ```bash
   git log --all --full-history -- "*env.local" "*env.production"
   # Should return nothing
   ```

---

## Next Steps

After completing these immediate actions, proceed with:

1. **Supabase Local Development Setup** (Priority 1)
   - See full implementation plan in `deployment-review-2026-01-22.md`
   - Estimated time: 1-2 days

2. **Readwise API Stub Server** (Priority 2)
   - See full implementation plan in `deployment-review-2026-01-22.md`
   - Estimated time: 1-2 days

3. **Secret Encryption in Database** (Priority 3)
   - See full implementation plan in `deployment-review-2026-01-22.md`
   - Estimated time: 2 days

---

## Summary of Changes

| Action                     | File                                | Time   | Impact                              |
| -------------------------- | ----------------------------------- | ------ | ----------------------------------- |
| Update .env.example        | `.env.example`                      | 5 min  | HIGH - Documents all secrets        |
| Add test isolation warning | `README.md`                         | 10 min | CRITICAL - Prevents data corruption |
| Add security headers       | `next.config.ts`                    | 10 min | MEDIUM - Improves security posture  |
| Create rotation docs       | `docs/devops/secret-rotation.md`    | 5 min  | MEDIUM - Operational clarity        |
| Add npm audit              | `.github/workflows/main.yml`        | 15 min | MEDIUM - Catches vulnerabilities    |
| Add API warnings           | Various test files                  | 30 min | LOW - Developer awareness           |
| Security checklist         | `docs/devops/SECURITY-CHECKLIST.md` | 15 min | MEDIUM - Process improvement        |

**Total Time**: ~90 minutes
**Total Impact**: Significantly improved security awareness and quick fixes for low-hanging fruit

---

**Created**: 2026-01-22
**Next Review**: After completing these actions, proceed with full deployment review implementation plan
